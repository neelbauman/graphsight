# 1. Soft Spatial Identity for Node Resolution

Date: 2026-01-28
Status: Accepted

## Context
フローチャート探索において、「Error」や「End」といった同名のノードが複数存在する場合、現在のIDベース（テキストのみ）の実装ではそれらを誤って同一視（マージ）してしまう問題がある。

これらを区別するために座標（Bounding Box）を利用する案が挙がったが、現在のVLM（GPT-4o等）はZero-shotでの座標出力精度が不安定であり、厳密なIoU（Intersection over Union）判定を行うと、同一ノードであっても「座標がズレているから別物」と誤判定され、グラフが破綻するリスクが高い。

## Decision
ノードの同一性判定において、**「テキスト一致」を主軸とし、「空間情報（座標）」を補助的に利用する "Soft Spatial Identity" 戦略** を採用する。

1.  **Primary Key:** ノードの正規化されたテキスト（例: "Error"）。
2.  **Disambiguation:** テキストが一致する既存ノードが存在する場合のみ、座標（BBox）の重心距離を比較する。
3.  **Soft Matching:** 厳密な重なりではなく、画像サイズに対する相対距離（例: 幅の10%以内）で「近傍」にあれば同一とみなす。

## Consequences
* **Positive:** VLMの座標出力が多少ブレても、誤って別ノードとして扱われるリスクを低減できる。同時に、離れた場所にある同名ノードは正しく分離できる。
* **Negative:** `Focus` オブジェクトにBBox情報の保持が必須となり、VLMへのトークン消費量（出力トークン）が若干増加する。
* **Risk:** 図の中に「全く同じテキストのノードが極めて近距離に配置されている」稀なケースでは、誤ってマージされる可能性がある。
