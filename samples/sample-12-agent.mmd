flowchart TD

%% Top row
N1["対象記事の確定・管理者の調査"] --> N2["方針決定・法律相談"] --> N3["記事を証拠として確保"]
N3 --> N14{目的}

%% Purpose split
N14 -->|削除のみ| N20
N14 -->|削除＋開示| N4

%% Disclosure route (left/center)
N4{CPの対応} -->|任意開示確実| N5["任意削除請求"]
N4 -->|任意開示不確実| N6{電話番号}
N5 --> N6

N6 -->|保存可能性なし| N7["IP開示仮処分"]
N6 -->|保存可能性あり| N15["IP開示＆電話消去禁止仮処分"]

N7 -->|発令| N8["IP開示＆削除"]
N15 -->|発令・和解等| N16["電話番号保存"]
N15 -->|発令| N8

N8 --> N9["whoisでAP特定"] --> N10{APにログ保存要請}
N10 -->|任意の協力が得られない| N11["消去禁止仮処分"] --> N12["APに開示訴訟"]
N10 -->|成功・保存完了| N12
N12 -->|認容| N13(["AP契約住所氏名開示"])

%% Phone-number route (right)
N16 --> N17["CPに電話開示訴訟"]
N17 -->|認容・開示| N18["電話会社に弁護士会照会"] --> N19(["電話番号契約者判明"])

%% Cross-links shown in the chart area (best-effort)
N13 -.->|発信者判明せず| N17
N17 -.->|ログなし| N13

%% Delete-only sub-flow (blue box)
subgraph DELETEONLY["削除のみの場合"]
  direction TD
  N20{CPの対応} -->|裁判必須ではない| N21["任意削除請求"] --> N22{削除結果}
  N20 -->|裁判必須| N23["仮処分申立"]
  N22 -->|削除| N24(["削除完了"])
  N22 -->|削除拒否| N23
  N23 -->|発令| N24
end

%% Styling
classDef green fill:#cfecc1,stroke:#2e7d32,stroke-width:1px,color:#000;
classDef orange fill:#f7c38a,stroke:#c06a00,stroke-width:1px,color:#000;
classDef blue fill:#9fd0ff,stroke:#1565c0,stroke-width:1px,color:#000;
classDef redstroke fill:#ffffff,stroke:#d32f2f,stroke-width:2px,color:#000;

class N8,N16 green;
class N13,N19 orange;
class N24 blue;
class N1 redstroke;